/**
 * Webpack plugin to prevent extraneous assets from being emitted for stylesheets.
 *
 * JS files and PHP asset files generated by `DependencyExtractionWebpackPlugin` are currently ignored.
 */
class IgnoreExtraneousStyleAssets {
	constructor() {
		this.cssEntries = [];
	}

	isCssFile( file ) {
		return /^(?!!!).+\.(?:sc|sa|c)ss$/.test( file );
	}

	generateIgnoreRegex() {
		const expression = this.cssEntries
			.map( ( entry ) => [ `${ entry }.js`, `${ entry }.asset.php` ] )
			.flat()
			.join( '|' );

		return new RegExp( expression );
	}

	apply( compiler ) {
		compiler.hooks.compilation.tap( 'IgnoreExtraneousStyleAssets', ( compilation ) => {
			// The `addEntry` compilation hook is undocumented. As for why, ¯\_(ツ)_/¯.
			compilation.hooks.addEntry.tap( 'IgnoreExtraneousStyleAssets', ( entry, name ) => {
				if ( entry.type === 'single entry' ) {
					if ( this.isCssFile( entry.request ) ) {
						this.cssEntries.push( name );
					}
				} else if ( entry.type === 'multi entry' ) {
					const filteredDependencies = entry.dependencies.filter(
						( singleDependency ) => this.isCssFile( singleDependency.request ),
					);

					// If all dependencies of the entry are CSS files, add it to the list of entries to ignore.
					if ( entry.dependencies.length === filteredDependencies.length ) {
						this.cssEntries.push( name );
					}
				}
			} );
		} );

		compiler.hooks.emit.tap( 'IgnoreExtraneousStyleAssets', ( compilation ) => {
			if ( this.cssEntries.length === 0 ) {
				return;
			}

			const ignoreRegex = this.generateIgnoreRegex();

			Object.keys( compilation.assets ).forEach( ( assetName ) => {
				if ( ignoreRegex.test( assetName ) ) {
					delete compilation.assets[ assetName ];
				}
			} );
		} );
	}
}

module.exports = IgnoreExtraneousStyleAssets;
